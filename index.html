<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Record & Watt & Percentuale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        .input-group label {
            display: block;
            color: #4b5563;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .input-group select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            outline: none;
            cursor: pointer;
        }
        .input-group select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .result-container {
            margin-top: 1rem;
            padding: 1.5rem;
            background-color: #e0e7ff;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e40af;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease-in-out;
        }
        .error-container {
            background-color: #fecaca;
            color: #7f1d1d;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Watt e dispendi Ergo</h1>
    
    <div class="input-group">
        <label for="nameSelect">Seleziona un nome:</label>
        <select id="nameSelect" class="w-full" onchange="findTime()">
            <option value="">Caricamento dati...</option>
        </select>
    </div>
    
    <div id="time-result-container" class="result-container text-red-900">
        Seleziona un nome
    </div>

    <div id="time-divided-result-container" class="result-container mt-4">
        Media
    </div>

    <div id="watt-result-container" class="result-container mt-4">
        Watt Record
    </div>
    
    <div class="input-group mt-6">
        <label for="percentageSelect">Seleziona una percentuale:</label>
        <select id="percentageSelect" class="w-full" onchange="calculateWattsWithPercentage()">
            <option value="">Seleziona una percentuale...</option>
            <option value="50">50%</option>
            <option value="55">55%</option>
            <option value="60">60%</option>
            <option value="65">65%</option>
            <option value="70">70%</option>
            <option value="75">75%</option>
            <option value="80">80%</option>
            <option value="85">85%</option>
            <option value="90">90%</option>
            <option value="95">95%</option>
            <option value="100">100%</option>
            <option value="105">105%</option>
            <option value="110">110%</option>
            <option value="115">115%</option>
            <option value="120">120%</option>
            <option value="125">125%</option>
            <option value="130">130%</option>
        </select>
    </div>

    <div id="percentage-time-result-container" class="result-container mt-4">
        Tempo dispendio
    </div>

    <div id="percentage-time-divided-result-container" class="result-container mt-4">
        Media Dispendio
    </div>
    
    <div id="percentage-watt-result-container" class="result-container mt-4">
        Watt - dispendio
    </div>
</div>

<script>
    // Variabile globale per memorizzare i dati caricati dal Google Sheet
    let times = {};
    // Variabile globale per memorizzare i Watt base (100%)
    let baseWatts = 0;

    // URL corretto del tuo Google Sheet esportato in formato CSV.
    // Ho convertito l'URL del tuo foglio di calcolo per renderlo accessibile.
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwqfeGstihfQX7-YBJ61orNnvkA5AptJ7UDx3NMOSARJPHXVm_JqOXOkL9OFWVbUlrpOUliFbgBcae/pub?gid=0&single=true&output=csv';

    /**
     * Funzione per convertire una stringa di tempo (es. "MM:SS.S") in secondi totali.
     * @param {string} timeString La stringa di tempo da convertire.
     * @returns {number} Il tempo totale in secondi.
     */
    function convertTimeToSeconds(timeString) {
        if (!timeString) return 0;
        // Gestisce il formato "MM.SS", convertendolo in "MM:SS"
        if (timeString.includes('.')) {
            timeString = timeString.replace('.', ':');
        }
        
        const parts = timeString.split(':').map(part => parseFloat(part));
        const minutes = parts[0] || 0;
        const seconds = parts[1] || 0;

        return (minutes * 60) + seconds;
    }

    /**
     * Calcola i Watt in base a un tempo totale in secondi.
     * @param {number} totalSeconds Il tempo totale in secondi.
     * @returns {number} I Watt calcolati.
     */
    function calculateWatts(totalSeconds) {
        if (totalSeconds === 0) {
            return 0; // Evita la divisione per zero
        }
        return 2.8 * Math.pow(2000 / totalSeconds, 3);
    }
    
    /**
     * Converte i secondi totali in una stringa "MM:SS.S".
     * @param {number} totalSeconds Il tempo totale in secondi.
     * @returns {string} La stringa di tempo formattata.
     */
    function formatSecondsToTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        const formattedSeconds = seconds.toFixed(1);
        
        const minutesString = String(minutes).padStart(2, '0');
        const secondsString = String(formattedSeconds).padStart(4, '0');
        
        return `${minutesString}:${secondsString}`;
    }

    /**
     * Esegue la ricerca del tempo e il calcolo dei Watt.
     */
    function findTime() {
        const selectedName = document.getElementById('nameSelect').value;
        const timeResultContainer = document.getElementById('time-result-container');
        const timeDividedResultContainer = document.getElementById('time-divided-result-container');
        const wattResultContainer = document.getElementById('watt-result-container');
        const percentageSelect = document.getElementById('percentageSelect');
        const percentageWattResultContainer = document.getElementById('percentage-watt-result-container');
        const percentageTimeResultContainer = document.getElementById('percentage-time-result-container');
        const percentageTimeDividedResultContainer = document.getElementById('percentage-time-divided-result-container');

        // Imposta i valori di default per i contenitori delle percentuali.
        percentageWattResultContainer.textContent = "Watt - dispendio";
        percentageTimeResultContainer.textContent = "Tempo dispendio";
        percentageTimeDividedResultContainer.textContent = "Media Dispendio";
        
        // Se non è stato selezionato un nome, mostra un messaggio di default
        if (selectedName === "") {
            timeResultContainer.textContent = "Seleziona un nome";
            timeResultContainer.classList.add('text-red-900');
            timeResultContainer.classList.remove('error-container');
            timeDividedResultContainer.textContent = "Media";
            wattResultContainer.textContent = "Watt Record";
            timeDividedResultContainer.classList.remove('error-container');
            wattResultContainer.classList.remove('error-container');
            baseWatts = 0; // Reset della variabile globale
            percentageSelect.value = ""; // Reset della selezione percentuale
            return;
        }

        // Cerca il tempo corrispondente al nome
        const timeString = times[selectedName];

        if (timeString) {
            // Mostra il tempo
            timeResultContainer.textContent = `Tempo: ${timeString}`;
            timeResultContainer.classList.remove('text-red-900');
            timeResultContainer.classList.remove('error-container');

            // Converte il tempo in secondi
            const totalSeconds = convertTimeToSeconds(timeString);

            // Calcola e mostra il tempo diviso per 4
            const timeDividedByFour = totalSeconds / 4;
            const formattedTimeDivided = formatSecondsToTime(timeDividedByFour);
            timeDividedResultContainer.textContent = `Media: ${formattedTimeDivided}`;
            timeDividedResultContainer.classList.remove('error-container');
            
            // Calcola i Watt base (100%)
            baseWatts = calculateWatts(totalSeconds);

            // Se il tempo è 0, mostra un messaggio di errore per il calcolo
            if (totalSeconds === 0) {
                wattResultContainer.textContent = "Tempo non valido per il calcolo.";
                wattResultContainer.classList.add('error-container');
                percentageWattResultContainer.textContent = "Impossibile calcolare i Watt percentuali.";
                percentageWattResultContainer.classList.add('error-container');
                percentageTimeResultContainer.textContent = "Impossibile calcolare il tempo percentuale.";
                percentageTimeResultContainer.classList.add('error-container');
                percentageTimeDividedResultContainer.textContent = "Impossibile calcolare il tempo percentuale / 4.";
                percentageTimeDividedResultContainer.classList.add('error-container');
            } else {
                // Mostra il risultato dei Watt, arrotondato a due decimali
                wattResultContainer.textContent = `Watt Record: ${baseWatts.toFixed(2)}`;
                wattResultContainer.classList.remove('error-container');
            }

            // Calcola e mostra i Watt e il tempo percentuali quando un nome viene selezionato
            calculateWattsWithPercentage();

        } else {
            // Gestisce il caso in cui il nome non venga trovato
            timeResultContainer.textContent = "Nome non trovato.";
            wattResultContainer.textContent = "Impossibile calcolare i Watt.";
            timeDividedResultContainer.textContent = "Impossibile calcolare la media.";
            percentageWattResultContainer.textContent = "Impossibile calcolare i Watt percentuali.";
            percentageTimeResultContainer.textContent = "Impossibile calcolare il tempo dispendio.";
            percentageTimeDividedResultContainer.textContent = "Impossibile calcolare la media dispendio.";
            timeResultContainer.classList.add('error-container');
            wattResultContainer.classList.add('error-container');
            timeDividedResultContainer.classList.add('error-container');
            percentageWattResultContainer.classList.add('error-container');
            percentageTimeResultContainer.classList.add('error-container');
            percentageTimeDividedResultContainer.classList.add('error-container');
        }
    }
    
    /**
     * Calcola e mostra i Watt e il tempo in base alla percentuale selezionata.
     */
    function calculateWattsWithPercentage() {
        const selectedPercentage = document.getElementById('percentageSelect').value;
        const percentageWattResultContainer = document.getElementById('percentage-watt-result-container');
        const percentageTimeResultContainer = document.getElementById('percentage-time-result-container');
        const percentageTimeDividedResultContainer = document.getElementById('percentage-time-divided-result-container');

        // Se non è selezionata una percentuale, non fare nulla.
        if (!selectedPercentage || baseWatts === 0) {
            return;
        }

        const percentage = parseFloat(selectedPercentage) / 100;
        const finalWatts = baseWatts * percentage;
        
        // Calcola il tempo in base ai nuovi Watt
        let finalTimeInSeconds = 0;
        if (finalWatts > 0) {
            finalTimeInSeconds = 2000 / Math.pow(finalWatts / 2.8, 1/3);
        }

        const formattedTime = formatSecondsToTime(finalTimeInSeconds);
        
        // Calcola e mostra il tempo percentuale diviso per 4
        const finalTimeDividedByFour = finalTimeInSeconds / 4;
        const formattedFinalTimeDivided = formatSecondsToTime(finalTimeDividedByFour);

        percentageWattResultContainer.textContent = `Watt - dispendio (${selectedPercentage}%): ${finalWatts.toFixed(2)}`;
        percentageWattResultContainer.classList.remove('error-container');
        
        percentageTimeResultContainer.textContent = `Tempo dispendio (${selectedPercentage}%): ${formattedTime}`;
        percentageTimeResultContainer.classList.remove('error-container');

        percentageTimeDividedResultContainer.textContent = `Media Dispendio (${selectedPercentage}%): ${formattedFinalTimeDivided}`;
        percentageTimeDividedResultContainer.classList.remove('error-container');
    }

    /**
     * Funzione per caricare i dati dal Google Sheet e popolare il selettore
     */
    async function loadDataAndPopulateSelect() {
        const selectElement = document.getElementById('nameSelect');
        try {
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            
            // Converte il testo CSV in un array di righe, saltando la prima (intestazione)
            const rows = csvText.trim().split('\n').slice(1);
            
            // Pulisce le opzioni esistenti, tranne quella di default
            selectElement.innerHTML = '<option value="">Seleziona un nome...</option>';
            
            // Itera su ogni riga per creare le opzioni e l'oggetto 'times'
            rows.forEach(row => {
                const [name, timeString] = row.split(',');
                const cleanName = name.trim().toUpperCase();
                const cleanTimeString = timeString.trim();
                
                // Ignora le righe senza nome o tempo
                if (cleanName && cleanTimeString) {
                    // Popola l'oggetto globale 'times' con i dati
                    times[cleanName] = cleanTimeString;
                    
                    // Crea e aggiunge l'opzione alla lista a discesa
                    const option = document.createElement('option');
                    option.value = cleanName;
                    option.textContent = cleanName;
                    selectElement.appendChild(option);
                }
            });
        } catch (error) {
            console.error("Errore nel caricamento dei dati dal Google Sheet:", error);
            selectElement.innerHTML = '<option value="">Errore di caricamento</option>';
            // Sostituisce l'alert con un messaggio nell'interfaccia utente
            document.getElementById('time-result-container').textContent = "Errore nel caricamento dei dati. Controlla la console.";
            document.getElementById('time-result-container').classList.add('error-container');
        }
    }

    // Chiama la funzione all'avvio della pagina
    window.onload = loadDataAndPopulateSelect;
</script>

</body>
</html>
